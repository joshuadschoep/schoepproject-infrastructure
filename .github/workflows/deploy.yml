name: Deploy
on:
  push:
    branches: main

jobs:
  upload:
    runs-on: ubuntu-latest
    env:
      AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
      AWS_TEMPLATE_FILE: ${{ secrets.AWS_TEMPLATE_FILE }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Configure S3 Upload Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::145724753995:role/schoepproject-infrastructure-github-action-role
          role-session-name: Github-Actions-Upload-CloudFormation-Template
      - name: Upload Template to S3
        run: bash ./.github/scripts/upload.sh
  deploy:
    runs-on: ubuntu-latest
    needs: upload
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure CloudFormation Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::145724753995:role/schoepproject-infrastructure-github-action-role
          role-session-name: Github-Actions-Modify-Stack
      - name: Create CloudFormation Change
        uses: aws-actions/aws-cloudformation-github-deploy@master
        with:
          name: ${{ secrets.AWS_STACK_NAME }}
          template: ${{ secrets.AWS_S3_URL }}/${{ secrets.AWS_TEMPLATE_FILENAME }}
          no-fail-on-empty-changeset: "1"
